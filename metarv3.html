<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Pilot Widget V3</title>
    <style>
        :root {
            --bg: #ffffff;
            --text: #37352f;
            --sub-text: #787774;
            --border: #e9e9e8;
            --code-bg: #f7f6f3;
            --accent: #2e86de;
            
            /* Flight Categories */
            --vfr: #2ecc71;
            --mvfr: #3498db;
            --ifr: #e74c3c;
            --lifr: #9b59b6;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #191919;
                --text: #d9d9d9;
                --sub-text: #9b9a97;
                --border: #2f2f2f;
                --code-bg: #262626;
            }
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 16px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* --- HEADER & INPUT --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-box {
            display: flex;
            gap: 6px;
            flex-grow: 1;
        }

        /* Improved Input for Datalist */
        input {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 4px;
            width: 100%; /* Take available space */
            max-width: 120px;
            text-transform: uppercase;
            font-weight: 600;
        }

        button.search-btn {
            background: var(--text);
            color: var(--bg);
            border: none;
            padding: 0 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }

        /* --- TABS --- */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }
        .tab {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--sub-text);
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            color: var(--text);
            border-bottom-color: var(--text);
        }

        /* --- INFO BADGES --- */
        .status-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-weight: 700;
            font-size: 11px;
        }

        .time-ago {
            color: var(--sub-text);
            font-style: italic;
        }

        /* --- WEATHER DATA --- */
        .data-grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr 1fr; /* Adjusted for wind width */
            gap: 8px;
            margin-bottom: 8px;
        }

        .data-item .label {
            font-size: 10px;
            color: var(--sub-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .data-item .value {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- WIND ARROW STYLING --- */
        .wind-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        #windArrowIcon {
            width: 14px;
            height: 14px;
            transition: transform 0.5s ease-out; /* Smooth rotation */
            fill: var(--text);
        }

        /* --- RAW TEXT BOX --- */
        .raw-box {
            background: var(--code-bg);
            padding: 10px;
            border-radius: 6px;
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: var(--text);
            border-left: 3px solid var(--sub-text);
            white-space: pre-wrap;
        }

        /* --- FOOTER --- */
        .footer {
            margin-top: auto;
            display: flex;
            justify-content: flex-end;
        }
        .ext-link {
            color: var(--sub-text);
            text-decoration: none;
            font-size: 11px;
        }
        .ext-link:hover { text-decoration: underline; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="search-box">
            <input list="airports" id="icao" value="RCTP" onkeydown="if(event.key==='Enter') loadData()" onclick="this.select()">
            <datalist id="airports">
                <option value="RCTP">Taoyuan</option>
                <option value="RCSS">Songshan</option>
                <option value="KMCC">Sacraento Mather</option>
                <option value="VHHH">Hong Kong</option>
                <option value="RJTT">Tokyo Haneda</option>
            </datalist>
            
            <button class="search-btn" onclick="loadData()">Go</button>
        </div>
        <div id="flightCat" class="badge hidden">VFR</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('metar')">METAR</div>
        <div class="tab" onclick="switchTab('taf')">TAF</div>
    </div>

    <div id="metarView">
        <div class="status-bar">
            <span id="metarAge" class="time-ago">-- min ago</span>
        </div>

        <div class="data-grid">
            <div class="data-item">
                <div class="label">Wind</div>
                <div class="value">
                    <svg id="windArrowIcon" viewBox="0 0 24 24">
                        <path d="M12 2L12 22M12 22L5 15M12 22L19 15" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                    <span id="windText">--</span>
                </div>
            </div>
            
            <div class="data-item">
                <div class="label">Vis</div>
                <div class="value" id="vis">--</div>
            </div>
            
            <div class="data-item">
                <div class="label">Clouds</div>
                <div class="value" id="clouds">--</div>
            </div>
        </div>

        <div class="raw-box" id="rawMetar">Loading...</div>
    </div>

    <div id="tafView" class="hidden">
        <div class="status-bar">
            <span class="time-ago">Forecast</span>
        </div>
        <div class="raw-box" id="rawTaf" style="border-left-color: var(--accent);">
            Checking forecast...
        </div>
    </div>

    <div class="footer">
        <a href="#" id="skyvectorLink" target="_blank" class="ext-link">Open SkyVector ↗</a>
    </div>

    <script>
        // ----------------------------------------------------
        const TOKEN = 'dMzS0-M9_ku1bYySTtsq4pZE8fEEiTUJaNtvqSDEgUs';
        // ----------------------------------------------------

        let currentIcao = 'RCTP';

        async function loadData() {
            const input = document.getElementById('icao').value.toUpperCase();
            if(!input) return;
            currentIcao = input;

            // Update External Link
            document.getElementById('skyvectorLink').href = `https://skyvector.com/airport/${currentIcao}`;

            // --- 1. Fetch METAR ---
            fetch(`https://avwx.rest/api/metar/${currentIcao}`, { headers: {'Authorization': `Bearer ${TOKEN}`}})
                .then(res => {
                    if(!res.ok) throw new Error('API Error');
                    return res.json();
                })
                .then(data => updateMetar(data))
                .catch(err => {
                    console.error(err);
                    document.getElementById('rawMetar').innerText = "Station not found or API error.";
                });

            // --- 2. Fetch TAF ---
            fetch(`https://avwx.rest/api/taf/${currentIcao}`, { headers: {'Authorization': `Bearer ${TOKEN}`}})
                .then(res => res.json())
                .then(data => updateTaf(data))
                .catch(err => {
                    document.getElementById('rawTaf').innerText = "TAF not available.";
                });
        }

        function updateMetar(data) {
            // Raw Text
            document.getElementById('rawMetar').innerText = data.raw;

            // Flight Rules Badge
            const cat = document.getElementById('flightCat');
            cat.innerText = data.flight_rules;
            cat.classList.remove('hidden');
            
            // Color Logic
            const rule = data.flight_rules;
            if(rule === 'VFR') cat.style.backgroundColor = 'var(--vfr)';
            else if(rule === 'MVFR') cat.style.backgroundColor = 'var(--mvfr)';
            else if(rule === 'IFR') cat.style.backgroundColor = 'var(--ifr)';
            else cat.style.backgroundColor = 'var(--lifr)';

            // --- WIND LOGIC ---
            const windDir = data.wind_direction?.value;
            const windSpeed = data.wind_speed?.value;
            const arrow = document.getElementById('windArrowIcon');
            
            if (windDir !== null && windDir !== undefined) {
                // Text
                document.getElementById('windText').innerText = `${windDir}° / ${windSpeed}kt`;
                
                // Rotation Logic: 
                // SVG points DOWN (180). 
                // If wind is 360 (North), we want arrow pointing DOWN (showing flow from North).
                // So rotate = windDir - 180.
                // Example: Wind 090 (East). Flow is towards West (270). 90 - 180 = -90 (Left). Correct.
                arrow.style.transform = `rotate(${windDir - 180}deg)`;
                arrow.style.display = 'block';
            } else {
                // Variable or Calm
                document.getElementById('windText').innerText = data.raw.includes('VRB') ? 'VRB' : 'Calm';
                arrow.style.display = 'none'; // Hide arrow if variable
            }

            // Visibility
            document.getElementById('vis').innerText = data.visibility?.value + ' sm';
            
            // Clouds
            if(data.clouds && data.clouds.length > 0) {
                document.getElementById('clouds').innerText = `${data.clouds[0].repr}`;
            } else {
                document.getElementById('clouds').innerText = 'CLR';
            }

            // Time Ago
            const reportTime = new Date(data.time.dt);
            const now = new Date();
            const diffMins = Math.floor((now - reportTime) / 60000);
            
            const ageSpan = document.getElementById('metarAge');
            ageSpan.innerText = `Issued ${diffMins}m ago`;
            if(diffMins > 60) ageSpan.style.color = 'var(--ifr)'; 
            else ageSpan.style.color = 'var(--sub-text)';
        }

        function updateTaf(data) {
            if(data.raw) {
                document.getElementById('rawTaf').innerText = data.raw;
            } else {
                 document.getElementById('rawTaf').innerText = "No TAF issued.";
            }
        }

        function switchTab(tabName) {
            const metarView = document.getElementById('metarView');
            const tafView = document.getElementById('tafView');
            const tabs = document.querySelectorAll('.tab');

            if(tabName === 'metar') {
                metarView.classList.remove('hidden');
                tafView.classList.add('hidden');
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
            } else {
                metarView.classList.add('hidden');
                tafView.classList.remove('hidden');
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
            }
        }

        loadData();
    </script>
</body>
</html>